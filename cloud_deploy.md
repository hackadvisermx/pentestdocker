# Despliegue del pentestdocker en la nube
Es posible usar terraform y ansible para crear y aprovisionar de manera autómatica tu vps y desplegar el pentestdocker. 

## Contenido
- [Requerimientos](#requerimientos)
- [Credenciales](#credenciales)
- [Automatización](#automatización)
- [Seguridad](#seguridad)

## Requerimientos
- Instalar terraform (yo usé: v0.13.5)
- Instalar ansible (yo usé: 20.10.13)
- Llaves SSH pública y privada  

## Credenciales
Para poder acceder al proveedor en nube y posteriormente al servidor vps una vez creado, debrás contar con las credenciales necesarias.
- Crea la carpeta credenciales
```
mkdir creds
```
### Para google cloud
- Crear un nuevo proyecto [ver como](https://cloud.google.com/resource-manager/docs/creating-managing-projects).
- Crear una cuenta de servicio con el rol "Compute Admin" y descargar la llave en formato json y ponerla en la carpeta _credenciales_ con el nombre de _tester.json_.
- Habilita el API "Compute Engine API" [ver como](https://cloud.google.com/endpoints/docs/openapi/enable-api).
### Para digital ocean cloud
- Crear un nuevo proyecto
- Crear token de acceso personal [ver como](https://www.digitalocean.com/docs/apis-clis/api/create-personal-access-token/).
### Crear llaves SSH 
- Dentro de la carpeta _creds_ ejecuta:
```
ssh-keygen -t rsa -f tester
```
- Esto crea dos archivos las llaves pública y privada:
```
tester
tester.pub
```

## Automatvización
La automatización completa del despliegue del contenedaro en la nube se hace con Terrafor y Ansible.

### Desplegar pentestdocker en la nube de google
- Moverte a la carpeta _gpc_.
- Modificar el archivo main.tf y cambia el valor con tu _project-id_.
- Dentro de la carpeta _gpc_ ejecuta:
```
cd gpc
terraform init
terraform apply -auto-approve
```
### Desplegar pentestdocker en la nube digital ocean
- Moverte a la carpeta _docp_.
- Dentro de la carpeta _docp_ ejecuta:
```
cd docp
TF_VAR_do_token="token_aqui"
terraform init
terraform apply -auto-approve
```
Nota: Lo anterior crea el VPS en la nube usando el acceso del propietario, crea una cuenta de usuario llamada _tester_ y descarga la imagen de **pentestdocker**.

### Conectarse a pentestdocker en la nube
Una vez desplegado **pentestdocker** en la nube, para acceder a el, usar las llaves SSH creadas anteriormente con la IP generada al ejecutar los comandos de despliegue anteriores:
```
ssh -i creds/tester tester@ipvps
```
### Iniciar pentetdocker en la nube
Para usar el pentestdocker desplegado en la nube usar los alias en _onhost/_ copiados a _/home/tester/.zshrc_ 
 
### Destuir VPS
- Moverte a la carpeta _gcp_ o _docp_ y ejecuta:
```
terraform destroy -auto-aprove
```
Nota: Para digital ocean si no tienes un VPS por defecto creado en la región, suele salir un mensaje de error al desstruir el VPS pero no importa, se destruyen los demás recursos.

## Seguridad
Como parte del despliegue, ansible instala el servicio **fail2ban** para evitar ataques de buerza bruta y evitar usuarios no autorizados.